# 步骤1：检查原始数据中的dest_ip
index="*int_firewall_palo_traffic" (dvc_name=GAEQUXATIFWO1 OR dvc_name=GAEQUXATIFWO2 OR dvc_name=GAEQUXATIFWO3 OR dvc_name=GAEQUXATIFWO4) (src_translated_ip != "0.0.0.0")
| head 5
| table dest_ip

# 步骤2：检查CSV数据
| inputlookup MS_IP.csv
| head 5
| table subnet

# 步骤3：单个IP测试
index="*int_firewall_palo_traffic" (dvc_name=GAEQUXATIFWO1 OR dvc_name=GAEQUXATIFWO2 OR dvc_name=GAEQUXATIFWO3 OR dvc_name=GAEQUXATIFWO4) (src_translated_ip != "0.0.0.0")
| head 1
| eval test_subnet="4.128.0.0/9"
| eval match=if(cidrmatch(test_subnet, dest_ip), 1, 0)
| table dest_ip, test_subnet, match

# 步骤4：修改后的完整查询
index="*int_firewall_palo_traffic" (dvc_name=GAEQUXATIFWO1 OR dvc_name=GAEQUXATIFWO2 OR dvc_name=GAEQUXATIFWO3 OR dvc_name=GAEQUXATIFWO4) (src_translated_ip != "0.0.0.0")
| append [| inputlookup MS_IP.csv | rename subnet as network | eval is_subnet=1]
| eval is_match=if(is_subnet=1, if(cidrmatch(network, dest_ip), 1, 0), null())
| where isnull(is_match) OR is_match=0
| table dest_ip, network, is_match

index="*int_firewall_palo_traffic" (dvc_name=GAEQUXATIFWO1 OR dvc_name=GAEQUXATIFWO2 OR dvc_name=GAEQUXATIFWO3 OR dvc_name=GAEQUXATIFWO4) (src_translated_ip != "0.0.0.0")
| append [| inputlookup MS_IP.csv]
| eval is_match=case(
    isnotnull(subnet) AND isnotnull(dest_ip), if(cidrmatch(subnet, dest_ip), 1, 0),
    true(), null()
)
| stats values(is_match) as matches by dest_ip
| eval final_match=if(max(matches)=1, 1, 0)
| where final_match=0
| fields dest_ip
